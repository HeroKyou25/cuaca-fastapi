<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Cuaca Real-time - Pontianak</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <style>
    body { font-family: Arial, sans-serif; background:#f5f5f5; margin:0; padding:20px; display:flex; flex-direction:column; align-items:center; }
    .card { background:#fff; padding:18px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); width:360px; margin-bottom:16px; text-align:center; }
    .city { font-weight:700; margin-bottom:6px; }
    .temp { font-size:2.6rem; margin:8px 0; }
    .desc { text-transform:capitalize; margin-bottom:6px; }
    .meta { font-size:0.9rem; color:#555; margin-bottom:6px; }
    #map { width:90%; max-width:1000px; height:420px; border-radius:10px; margin-top:12px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    .history-container { width:90%; max-width:1000px; background:#fff; border-radius:10px; padding:12px; margin-top:12px; box-shadow:0 4px 12px rgba(0,0,0,0.04); }
    table { width:100%; border-collapse:collapse; font-size:0.9rem; }
    th, td { padding:6px 8px; border-bottom:1px solid #eee; text-align:left; }
    thead { background:#fafafa; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Cuaca Real-time ‚Äî Kota Pontianak</h2>
    <div class="city" id="city">Mengambil data...</div>
    <div class="temp" id="temp">--¬∞C</div>
    <div class="desc" id="description">-</div>
    <div class="meta">
      <div id="feels_like">Feels like: --¬∞C</div>
      <div id="humidity">Humidity: --%</div>
      <div id="updated_at">Terakhir update: -</div>
    </div>
    <div id="status" style="font-size:0.85rem;color:#666;">Status: inisialisasi...</div>
  </div>

  <div class="history-container">
    <h3>Riwayat Cuaca Kota Pontianak</h3>
    <table id="historyTable">
      <thead>
        <tr><th>Waktu</th><th>Kota</th><th>Suhu</th><th>Deskripsi</th><th>Kelembapan</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <p style="width:90%; max-width:1000px; color:#444; margin:10px 0 6px 0;">
    üìç Peta (OpenStreetMap). Klik peta untuk menambah marker dan melihat cuaca di lokasi itu. Marker hanya untuk lookup ‚Äî dashboard tetap Pontianak.
  </p>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script>
    const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = wsProtocol + "://" + window.location.host + "/ws";

    const cityEl = document.getElementById("city");
    const tempEl = document.getElementById("temp");
    const descEl = document.getElementById("description");
    const feelsEl = document.getElementById("feels_like");
    const humEl = document.getElementById("humidity");
    const updatedAtEl = document.getElementById("updated_at");
    const statusEl = document.getElementById("status");

    // history table (Pontianak only)
    const historyBody = document.querySelector("#historyTable tbody");
    const MAX_HISTORY = 10;

    function log(s) {
      console.log(s);
      statusEl.textContent = "Status: " + s;
    }

    function addHistoryRow(data) {
      const tr = document.createElement("tr");
      const tempText = data.temp !== null && data.temp !== undefined ? (typeof data.temp === "number" ? data.temp.toFixed(1) + "¬∞C" : data.temp) : "--¬∞C";
      const humText = data.humidity !== null && data.humidity !== undefined ? data.humidity + "%" : "--%";
      tr.innerHTML = `<td>${data.updated_at || '-'}</td><td>${data.city || 'Pontianak'}</td><td>${tempText}</td><td>${data.description || '-'}</td><td>${humText}</td>`;
      historyBody.prepend(tr);
      while (historyBody.rows.length > MAX_HISTORY) historyBody.deleteRow(-1);
    }

    function applyWeatherToUI(data) {
      cityEl.textContent = data.city || "Pontianak";
      if (data.temp !== null && data.temp !== undefined) {
        tempEl.textContent = (typeof data.temp === "number" ? data.temp.toFixed(1) : data.temp) + "¬∞C";
      } else tempEl.textContent = "--¬∞C";

      descEl.textContent = data.description || "-";
      feelsEl.textContent = "Feels like: " + (data.feels_like !== null ? (typeof data.feels_like === "number" ? data.feels_like.toFixed(1) + "¬∞C" : data.feels_like) : "--¬∞C");
      humEl.textContent = "Humidity: " + (data.humidity !== null ? data.humidity + "%" : "--%");
      if (data.updated_at) updatedAtEl.textContent = "Terakhir update: " + data.updated_at;

      addHistoryRow(data);
    }

    // WebSocket ‚Äî Pontianak broadcasts
    let socket = null;
    function connectWebSocket() {
      log("menghubungkan WebSocket untuk Pontianak...");
      socket = new WebSocket(wsUrl);

      socket.onopen = () => log("WebSocket terhubung ‚úÖ (Pontianak)");
      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          console.log("WS DATA:", data);
          applyWeatherToUI(data);
        } catch (e) {
          console.error(e);
          log("gagal parsing data dari WebSocket");
        }
      };
      socket.onclose = () => {
        log("koneksi WebSocket putus, mencoba reconnect dalam 3 detik...");
        setTimeout(connectWebSocket, 3000);
      };
      socket.onerror = (err) => {
        console.error("WS error:", err);
        log("error WebSocket");
      };
    }
    connectWebSocket();

    // Map setup (marker per-click)
    const map = L.map("map").setView([-2.5, 118], 4);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 18 }).addTo(map);

    let lastMarker = null;

    async function fetchWeatherForCoords(lat, lon) {
      try {
        log(`ambil cuaca koordinat (${lat.toFixed(3)}, ${lon.toFixed(3)}) ...`);
        const res = await fetch(`/weather?lat=${lat}&lon=${lon}`);
        const data = await res.json();
        return data;
      } catch (e) {
        console.error("Error fetch /weather:", e);
        log("gagal ambil data dari server (map)");
        return null;
      }
    }

    map.on("click", async (e) => {
      const lat = e.latlng.lat;
      const lon = e.latlng.lng;

      const data = await fetchWeatherForCoords(lat, lon);
      if (!data) return;

      // place or move marker
      if (lastMarker) {
        lastMarker.setLatLng(e.latlng);
      } else {
        lastMarker = L.marker(e.latlng).addTo(map);
      }

      const city = data.city || "Lokasi";
      const desc = data.description || "-";
      const temp = (data.temp !== null && data.temp !== undefined) ? (typeof data.temp === "number" ? data.temp.toFixed(1) + "¬∞C" : data.temp) : "--¬∞C";
      const iconUrl = data.icon_url || (data.icon ? `https://openweathermap.org/img/wn/${data.icon}@2x.png` : null);

      // build popup content
      const content = document.createElement("div");
      content.style.textAlign = "center";
      const title = document.createElement("div");
      title.style.fontWeight = "700";
      title.textContent = city;
      content.appendChild(title);

      if (iconUrl) {
        const img = document.createElement("img");
        img.src = iconUrl;
        img.alt = desc;
        img.style.width = "64px";
        img.style.height = "64px";
        img.style.display = "block";
        img.style.margin = "6px auto";
        content.appendChild(img);
      }

      const p = document.createElement("div");
      p.innerHTML = `${temp}<br>${desc}`;
      content.appendChild(p);

      lastMarker.bindPopup(content).openPopup();
      log("Popup peta ditampilkan (lookup cepat).");
    });
  </script>
</body>
</html>
