<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Cuaca Real-time dengan Peta</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Leaflet CSS (peta) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />

  <!-- Weather Icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.10/css/weather-icons.min.css"
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    .card {
      background: #ffffff;
      padding: 20px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      width: 320px;
      text-align: center;
      margin-top: 30px;
      margin-bottom: 20px;
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 10px;
    }

    .city {
      font-weight: bold;
      margin-bottom: 8px;
    }

    .temp {
      font-size: 2.6rem;
      margin: 10px 0;
    }

    .desc {
      text-transform: capitalize;
      margin-bottom: 10px;
    }

    .meta {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 6px;
    }

    .debug {
      margin-top: 8px;
      font-size: 0.8rem;
      color: #777;
    }

    #map {
      width: 90%;
      max-width: 800px;
      height: 400px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      margin-bottom: 30px;
      background: #ddd;
    }

    .note {
      font-size: 0.85rem;
      color: #555;
      margin-bottom: 10px;
      text-align: center;
      max-width: 800px;
    }

    .history-container {
      width: 90%;
      max-width: 800px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      padding: 16px 20px;
      margin-bottom: 24px;
    }

    .history-container h2 {
      margin: 0 0 10px 0;
      font-size: 1.1rem;
    }

    #historyTable {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    #historyTable thead {
      background: #f1f1f1;
    }

    #historyTable th,
    #historyTable td {
      padding: 6px 8px;
      border-bottom: 1px solid #e0e0e0;
      text-align: left;
    }

    #historyTable tbody tr:nth-child(even) {
      background: #fafafa;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Cuaca Real-time</h1>
    <div class="city" id="city">Mengambil data...</div>

    <!-- ICON CUACA DI CARD -->
    <div style="margin: 6px 0;">
      <i id="weather_icon" class="wi wi-na" style="font-size: 48px;"></i>
    </div>

    <div class="temp" id="temp">--¬∞C</div>
    <div class="desc" id="description">-</div>

    <div class="meta">
      <span id="feels_like">Feels like: --¬∞C</span><br />
      <span id="humidity">Humidity: --%</span><br />
      <span id="updated_at">Terakhir update: -</span>
    </div>

    <div class="debug" id="debug">Status: inisialisasi...</div>
  </div>

  <!-- RIWAYAT CUACA -->
  <div class="history-container">
    <h2>Riwayat Cuaca</h2>
    <table id="historyTable">
      <thead>
        <tr>
          <th>Waktu</th>
          <th>Mode</th>
          <th>Kota</th>
          <th>Suhu</th>
          <th>Deskripsi</th>
          <th>Kelembapan</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <p class="note">
    üìç Peta (OpenStreetMap). Klik peta untuk menambah marker dan melihat cuaca di lokasi itu.
  </p>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <script>
    const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = wsProtocol + "://" + window.location.host + "/ws";

    const cityEl = document.getElementById("city");
    const tempEl = document.getElementById("temp");
    const descEl = document.getElementById("description");
    const feelsEl = document.getElementById("feels_like");
    const humEl = document.getElementById("humidity");
    const updatedAtEl = document.getElementById("updated_at");
    const debugEl = document.getElementById("debug");
    const iconEl = document.getElementById("weather_icon");

    let socket = null;
    let manualMode = false;

    const historyBody = document.querySelector("#historyTable tbody");
    const MAX_HISTORY = 20;

    function log(msg) {
      console.log(msg);
      debugEl.textContent = "Status: " + msg;
    }

    function addHistoryRow(data, mode) {
      // HANYA mode otomatis yang masuk riwayat
      if (mode !== "otomatis") return;
      if (!historyBody) return;

      const tr = document.createElement("tr");

      const tempText =
        data.temp !== null && data.temp !== undefined
          ? (typeof data.temp === "number"
              ? data.temp.toFixed(1)
              : data.temp) + "¬∞C"
          : "--¬∞C";

      const humText =
        data.humidity !== null && data.humidity !== undefined
          ? data.humidity + "%"
          : "--%";

      tr.innerHTML = `
        <td>${data.updated_at || "-"}</td>
        <td>${mode}</td>
        <td>${data.city || "?"}</td>
        <td>${tempText}</td>
        <td>${data.description || "-"}</td>
        <td>${humText}</td>
      `;

      historyBody.prepend(tr);

      while (historyBody.rows.length > MAX_HISTORY) {
        historyBody.deleteRow(-1);
      }
    }

    // === NORMALISASI KOORDINAT ===
    function clampLat(lat) {
      // biar gak nyentuh kutub ekstrem
      return Math.max(-89.9, Math.min(89.9, lat));
    }

    function normalizeLon(lon) {
      // bawa lon ke range [-180, 180]
      let x = ((lon + 180) % 360 + 360) % 360 - 180;
      return x;
    }

    // === ICON MAPPING: bedakan 800‚Äì804 ===
    function getIconClass(condition, code) {
      if (typeof code === "number") {
        if (code >= 200 && code < 300) return "wi-thunderstorm"; // badai
        if (code >= 300 && code < 400) return "wi-sprinkle";     // gerimis

        if (code >= 500 && code < 600) {                         // hujan
          if (code === 511) return "wi-rain-mix";                // freezing rain
          if (code >= 520) return "wi-showers";                  // shower
          return "wi-rain";
        }

        if (code >= 600 && code < 700) {                         // salju
          if (code >= 611 && code <= 622) return "wi-sleet";     // sleet
          return "wi-snow";
        }

        if (code >= 700 && code < 800) {                         // kabut/debu
          if (code === 781) return "wi-tornado";
          if (code === 771) return "wi-strong-wind";
          if (code === 741) return "wi-fog";
          return "wi-dust";
        }

        // 800‚Äì804 detail awan
        if (code === 800) return "wi-day-sunny";            // cerah
        if (code === 801) return "wi-day-sunny-overcast";   // sedikit awan
        if (code === 802) return "wi-cloud";                // awan tersebar
        if (code === 803) return "wi-cloudy";               // awan pecah
        if (code === 804) return "wi-cloudy-windy";         // mendung berat
      }

      switch (condition) {
        case "Thunderstorm": return "wi-thunderstorm";
        case "Drizzle":      return "wi-sprinkle";
        case "Rain":         return "wi-rain";
        case "Snow":         return "wi-snow";
        case "Mist":
        case "Smoke":
        case "Haze":
        case "Dust":
        case "Fog":
        case "Sand":
        case "Ash":
        case "Squall":
          return "wi-fog";
        case "Tornado":      return "wi-tornado";
        case "Clouds":       return "wi-cloudy";
        case "Clear":        return "wi-day-sunny";
        default:             return "wi-na";
      }
    }

    function applyWeatherToUI(data, mode = "otomatis", extra = {}) {
      let cityLabel = data.city;
      if (!cityLabel && extra.lat != null && extra.lon != null) {
        cityLabel = `Lat ${extra.lat.toFixed(2)}, Lon ${extra.lon.toFixed(2)}`;
      }
      cityEl.textContent = cityLabel || "Lokasi tidak diketahui";

      if (iconEl) {
        const cls = getIconClass(data.condition, data.condition_id);
        iconEl.className = "wi " + cls;
      }

      if (data.temp !== null && data.temp !== undefined) {
        const t = typeof data.temp === "number" ? data.temp.toFixed(1) : data.temp;
        tempEl.textContent = t + "¬∞C";
      } else {
        tempEl.textContent = "--¬∞C";
      }

      if (data.feels_like !== null && data.feels_like !== undefined) {
        const f = typeof data.feels_like === "number"
          ? data.feels_like.toFixed(2)
          : data.feels_like;
        feelsEl.textContent = "Feels like: " + f + "¬∞C";
      } else {
        feelsEl.textContent = "Feels like: --¬∞C";
      }

      if (data.humidity !== null && data.humidity !== undefined) {
        humEl.textContent = "Humidity: " + data.humidity + "%";
      } else {
        humEl.textContent = "Humidity: --%";
      }

      descEl.textContent = data.description || "-";

      // PENTING: pakai updated_at dari BACKEND (WIB)
      if (data.updated_at) {
        updatedAtEl.textContent = "Terakhir update: " + data.updated_at;
      }

      // Riwayat: hanya otomatis
      addHistoryRow(data, mode);
    }

    function connectWebSocket() {
      log("menghubungkan WebSocket (mode otomatis Pontianak)...");

      socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        log("WebSocket terhubung ‚úÖ (mode otomatis)");
      };

      socket.onmessage = (event) => {
        if (manualMode) return;
        try {
          const data = JSON.parse(event.data);
          console.log("DATA DARI WS:", data);
          applyWeatherToUI(data, "otomatis");
        } catch (e) {
          console.error("Error parsing message:", e);
          log("gagal parsing data dari WebSocket");
        }
      };

      socket.onclose = () => {
        if (!manualMode) {
          log("koneksi putus, mencoba ulang dalam 3 detik...");
          setTimeout(connectWebSocket, 3000);
        } else {
          log("WebSocket ditutup (mode manual via peta)");
        }
      };

      socket.onerror = (err) => {
        console.error("WebSocket error:", err);
        log("error WebSocket");
      };
    }

    async function fetchWeatherForCoords(rawLat, rawLon, marker) {
      // NORMALISASI KOORDINAT di sini
      const lat = clampLat(rawLat);
      const lon = normalizeLon(rawLon);

      try {
        log(`ambil cuaca koordinat (lat=${lat.toFixed(2)}, lon=${lon.toFixed(2)}) ...`);
        const res = await fetch(`/weather?lat=${lat}&lon=${lon}`);
        const data = await res.json();
        console.log("DATA DARI /weather:", data);

        // update card (manual, tidak ke riwayat)
        applyWeatherToUI(data, "manual", { lat, lon });
        log("mode manual (peta) - klik lagi untuk lokasi lain");

        const tempText =
          data.temp !== null && data.temp !== undefined
            ? (typeof data.temp === "number"
                ? data.temp.toFixed(1)
                : data.temp) + "¬∞C"
            : "--¬∞C";

        const iconClass = getIconClass(data.condition, data.condition_id);
        const popupCity =
          data.city || `Lat ${lat.toFixed(2)}, Lon ${lon.toFixed(2)}`;

        const popupHtml = `
          <div style="text-align:center;">
            <div><strong>${popupCity}</strong></div>
            <div style="font-size:24px; margin:4px 0;">
              <i class="wi ${iconClass}"></i>
            </div>
            <div style="font-size:12px;">${data.description || "-"}</div>
            <div style="font-size:12px;">${tempText}</div>
          </div>
        `;

        if (marker) {
          marker.bindPopup(popupHtml).openPopup();
        }
      } catch (e) {
        console.error("Error fetch /weather:", e);
        log("gagal ambil data dari server");
      }
    }

    function initMap() {
      // peta 1 dunia
      const map = L.map("map").setView([0, 0], 2);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      let marker = null;

      map.on("click", (e) => {
        const rawLat = e.latlng.lat;
        const rawLon = e.latlng.lng;

        manualMode = true;

        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.close();
        }

        // buat/geser marker di posisi KLIK (bukan yang sudah ternormalisasi)
        if (marker) {
          marker.setLatLng(e.latlng);
        } else {
          marker = L.marker(e.latlng).addTo(map);
        }

        fetchWeatherForCoords(rawLat, rawLon, marker);
      });
    }

    window.addEventListener("load", () => {
      connectWebSocket();
      initMap();

      const AUTO_MODE_DURATION_MS = 60 * 1000;
      setTimeout(() => {
        if (!manualMode && socket) {
          manualMode = true;
          log("Mode otomatis selesai (1 menit). Silakan pilih lokasi di peta.");
          if (socket.readyState === WebSocket.OPEN) {
            socket.close();
          }
        }
      }, AUTO_MODE_DURATION_MS);
    });
  </script>
</body>
</html>
