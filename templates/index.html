  <script>
    const wsProtocol = window.location.protocol === "https:" ? "wss" : "ws";
    const wsUrl = wsProtocol + "://" + window.location.host + "/ws";

    const cityEl = document.getElementById("city");
    const tempEl = document.getElementById("temp");
    const descEl = document.getElementById("description");
    const feelsEl = document.getElementById("feels_like");
    const humEl = document.getElementById("humidity");
    const updatedAtEl = document.getElementById("updated_at");
    const debugEl = document.getElementById("debug");

    let socket = null;
    let manualMode = false; // true kalau user sudah klik peta

    // RIWAYAT
    const historyBody = document.querySelector("#historyTable tbody");
    const MAX_HISTORY = 20;

    function log(msg) {
      console.log(msg);
      debugEl.textContent = "Status: " + msg;
    }

    function addHistoryRow(data, mode) {
      if (!historyBody) return;

      const tr = document.createElement("tr");

      const tempText =
        data.temp !== null && data.temp !== undefined
          ? (typeof data.temp === "number"
              ? data.temp.toFixed(1)
              : data.temp) + "°C"
          : "--°C";

      const humText =
        data.humidity !== null && data.humidity !== undefined
          ? data.humidity + "%"
          : "--%";

      tr.innerHTML = `
        <td>${data.updated_at || "-"}</td>
        <td>${mode}</td>
        <td>${data.city || "?"}</td>
        <td>${tempText}</td>
        <td>${data.description || "-"}</td>
        <td>${humText}</td>
      `;

      historyBody.prepend(tr);

      while (historyBody.rows.length > MAX_HISTORY) {
        historyBody.deleteRow(-1);
      }
    }

    function applyWeatherToUI(data, mode = "otomatis") {
      cityEl.textContent = data.city || "Lokasi tidak diketahui";

      if (data.temp !== null && data.temp !== undefined) {
        const t = typeof data.temp === "number" ? data.temp.toFixed(1) : data.temp;
        tempEl.textContent = t + "°C";
      } else {
        tempEl.textContent = "--°C";
      }

      if (data.feels_like !== null && data.feels_like !== undefined) {
        const f = typeof data.feels_like === "number"
          ? data.feels_like.toFixed(2)
          : data.feels_like;
        feelsEl.textContent = "Feels like: " + f + "°C";
      } else {
        feelsEl.textContent = "Feels like: --°C";
      }

      if (data.humidity !== null && data.humidity !== undefined) {
        humEl.textContent = "Humidity: " + data.humidity + "%";
      } else {
        humEl.textContent = "Humidity: --%";
      }

      descEl.textContent = data.description || "-";

      if (data.updated_at) {
        updatedAtEl.textContent = "Terakhir update: " + data.updated_at;
      }

      addHistoryRow(data, mode);
    }

    function connectWebSocket() {
      log("menghubungkan WebSocket (mode otomatis Pontianak)...");

      socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        log("WebSocket terhubung ✅ (mode otomatis)");
      };

      socket.onmessage = (event) => {
        if (manualMode) {
          // kalau sudah klik peta, abaikan data dari WebSocket
          return;
        }
        try {
          const data = JSON.parse(event.data);
          console.log("DATA DARI WS:", data);
          applyWeatherToUI(data, "otomatis");
        } catch (e) {
          console.error("Error parsing message:", e);
          log("gagal parsing data dari WebSocket");
        }
      };

      socket.onclose = () => {
        if (!manualMode) {
          log("koneksi putus, mencoba ulang dalam 3 detik...");
          setTimeout(connectWebSocket, 3000);
        } else {
          log("WebSocket ditutup (mode manual via peta)");
        }
      };

      socket.onerror = (err) => {
        console.error("WebSocket error:", err);
        log("error WebSocket");
      };
    }

    async function fetchWeatherForCoords(lat, lon) {
      try {
        log(`ambil cuaca koordinat (${lat.toFixed(2)}, ${lon.toFixed(2)}) ...`);
        const res = await fetch(`/weather?lat=${lat}&lon=${lon}`);
        const data = await res.json();
        console.log("DATA DARI /weather:", data);
        applyWeatherToUI(data, "manual");
        log("mode manual (peta) - klik lagi untuk lokasi lain");
      } catch (e) {
        console.error("Error fetch /weather:", e);
        log("gagal ambil data dari server");
      }
    }

    function initMap() {
      const map = L.map("map").setView([ -2.5, 118 ], 4);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      let marker = null;

      map.on("click", (e) => {
        const lat = e.latlng.lat;
        const lon = e.latlng.lng;

        manualMode = true;

        if (socket && socket.readyState === WebSocket.OPEN) {
          socket.close();
        }

        if (marker) {
          marker.setLatLng(e.latlng);
        } else {
          marker = L.marker(e.latlng).addTo(map);
        }

        fetchWeatherForCoords(lat, lon);
      });
    }

    window.addEventListener("load", () => {
      connectWebSocket(); // mode otomatis Pontianak dulu
      initMap();          // peta untuk pilih lokasi manual

      // === BATASI MODE OTOMATIS HANYA 1 MENIT ===
      const AUTO_MODE_DURATION_MS = 60 * 1000; // 1 menit
      setTimeout(() => {
        if (!manualMode && socket) {
          manualMode = true;
          log("Mode otomatis selesai (1 menit). Silakan pilih lokasi di peta.");
          if (socket.readyState === WebSocket.OPEN) {
            socket.close(); // akan memicu onclose, tapi tidak reconnect karena manualMode = true
          }
        }
      }, AUTO_MODE_DURATION_MS);
    });
  </script>
